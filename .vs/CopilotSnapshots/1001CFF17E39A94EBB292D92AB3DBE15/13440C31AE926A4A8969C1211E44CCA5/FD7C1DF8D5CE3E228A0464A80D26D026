using allofthesestarshaveareason.Models;
using allofthesestarshaveareason.Services.Interfaces;
using Microsoft.AspNetCore.Hosting;
using Microsoft.ML.OnnxRuntime;
using Microsoft.ML.OnnxRuntime.Tensors;
using Microsoft.ML.Tokenizers; 

namespace allofthesestarshaveareason.Services.Implementations;

public class OnnxTextAnalysisService : ITextAnalysisService, IDisposable
{
    private readonly InferenceSession _session;
    private readonly Tokenizer _tokenizer;
    private readonly ILogger<OnnxTextAnalysisService> _logger;
    private bool _disposed;

    public OnnxTextAnalysisService(IWebHostEnvironment env, ILogger<OnnxTextAnalysisService> logger)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        ArgumentNullException.ThrowIfNull(env);

        try
        {
            // Modeli ve tokenizer'ı yükle
            var modelPath = Path.Combine(env.ContentRootPath, "wwwroot", "ml-models", "model.onnx");
            var vocabPath = Path.Combine(env.ContentRootPath, "wwwroot", "ml-models", "vocab.txt");

            if (!File.Exists(modelPath))
            {
                throw new FileNotFoundException($"ONNX model file not found at: {modelPath}");
            }

            if (!File.Exists(vocabPath))
            {
                throw new FileNotFoundException($"Vocabulary file not found at: {vocabPath}");
            }

            _session = new InferenceSession(modelPath);
            
            // Load vocab file and create tokenizer
            using var stream = File.OpenRead(vocabPath);
            _tokenizer = BertTokenizer.Create(stream);
            
            _logger.LogInformation("ONNX model and tokenizer loaded successfully");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to initialize OnnxTextAnalysisService");
            throw;
        }
    }

    public async Task<List<SentenceEmbedding>> GenerateEmbeddingsAsync(List<TranscriptSegment> segments)
    {
        ObjectDisposedException.ThrowIf(_disposed, this);
        ArgumentNullException.ThrowIfNull(segments);

        if (segments.Count == 0)
        {
            _logger.LogWarning("No segments provided for embedding generation");
            return [];
        }

        return await Task.Run(() =>
        {
            try
            {
                List<SentenceEmbedding> embeddings = new();

                for (int i = 0; i < segments.Count; i++)
                {
                    var text = segments[i].Text ?? string.Empty;
                    if (string.IsNullOrWhiteSpace(text))
                    {
                        continue;
                    }

                    var embedding = GenerateEmbeddingForSingleText(text, $"segment_{i}");
                    if (embedding != null)
                    {
                        embeddings.Add(embedding);
                    }
                }

                _logger.LogInformation("Generated {Count} embeddings successfully", embeddings.Count);
                return embeddings;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error generating embeddings");
                throw new InvalidOperationException("Failed to generate embeddings", ex);
            }
        }).ConfigureAwait(false);
    }

    public List<TranscriptSegment> FindSimilarSentences(
        string query, 
        List<TranscriptSegment> allSegments, 
        List<SentenceEmbedding> allEmbeddings)
    {
        ObjectDisposedException.ThrowIf(_disposed, this);
        ArgumentNullException.ThrowIfNull(query);
        ArgumentNullException.ThrowIfNull(allSegments);
        ArgumentNullException.ThrowIfNull(allEmbeddings);

        if (string.IsNullOrWhiteSpace(query))
        {
            _logger.LogWarning("Empty query provided for similarity search");
            return [];
        }

        if (allSegments.Count == 0 || allEmbeddings.Count == 0)
        {
            return [];
        }

        try
        {
            // 1. Arama sorgusunu da aynı şekilde vektöre dönüştür.
            var queryEmbedding = GenerateEmbeddingsForSingleText(query);
            if (queryEmbedding == null || queryEmbedding.Length == 0)
            {
                _logger.LogWarning("Failed to generate embedding for query");
                return [];
            }

            // 2. Benzerlik skorlarını hesapla
            List<(TranscriptSegment segment, double score)> scoredSegments = new();
            int segmentCount = Math.Min(allSegments.Count, allEmbeddings.Count);
            
            for (int i = 0; i < segmentCount; i++)
            {
                var score = CosineSimilarity(queryEmbedding, allEmbeddings[i].Vector);
                scoredSegments.Add((allSegments[i], score));
            }

            // 3. Skorlara göre sırala ve en alakalı olanları döndür
            List<TranscriptSegment> results = scoredSegments
                .Where(s => !double.IsNaN(s.score))
                .OrderByDescending(s => s.score)
                .Take(5) // En iyi 5 sonucu al
                .Select(s => s.segment)
                .ToList();

            _logger.LogInformation("Found {Count} similar segments for query", results.Count);
            return results;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error finding similar sentences");
            return [];
        }
    }

    // Tek bir metin için SentenceEmbedding oluşturan yardımcı metot
    private SentenceEmbedding? GenerateEmbeddingForSingleText(string text, string segmentId)
    {
        try
        {
            var vector = GenerateEmbeddingsForSingleText(text);
            if (vector == null || vector.Length == 0)
            {
                return null;
            }

            return new SentenceEmbedding
            {
                SegmentId = segmentId,
                Vector = vector
            };
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error generating sentence embedding");
            return null;
        }
    }

    // Tek bir metin için embedding vektörü oluşturan yardımcı metot
    private float[]? GenerateEmbeddingsForSingleText(string text)
    {
        try
        {
            // Tokenize the text
            var encoded = _tokenizer.EncodeToTokens(text, out _);
            
            if (encoded == null || encoded.Count == 0)
            {
                return null;
            }

            // Convert tokens to IDs
            List<int> ids = encoded.Select(t => t.Id).ToList();
            List<int> attentionMask = new(Enumerable.Repeat(1, ids.Count));
            List<int> tokenTypeIds = new(Enumerable.Repeat(0, ids.Count));

            var inputIds = ConvertToTensor(ids);
            var attentionMaskTensor = ConvertToTensor(attentionMask);
            var tokenTypeIdsTensor = ConvertToTensor(tokenTypeIds);

            List<NamedOnnxValue> inputs =
            [
                NamedOnnxValue.CreateFromTensor("input_ids", inputIds),
                NamedOnnxValue.CreateFromTensor("attention_mask", attentionMaskTensor),
                NamedOnnxValue.CreateFromTensor("token_type_ids", tokenTypeIdsTensor)
            ];

            using var results = _session.Run(inputs);
            var lastHiddenState = results.First().AsTensor<float>();
            return MeanPooling(lastHiddenState, attentionMask);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error generating embedding for text");
            return null;
        }
    }

    // IReadOnlyList<int> to DenseTensor<long> converter
    private static DenseTensor<long> ConvertToTensor(List<int> ids)
    {
        if (ids.Count == 0)
        {
            return new DenseTensor<long>(new long[] { 0 }, new[] { 1, 1 });
        }

        long[] longArray = ids.Select(x => (long)x).ToArray();
        return new DenseTensor<long>(longArray, new[] { 1, longArray.Length });
    }

    // Model çıktısını anlamlı bir cümle vektörüne dönüştüren metot
    private static float[] MeanPooling(Tensor<float> tokenEmbeddings, List<int> attentionMask)
    {
        if (attentionMask.Count == 0)
        {
            return [];
        }

        int tokenCount = attentionMask.Count;
        int embeddingDim = (int)(tokenEmbeddings.Length / tokenCount);
        
        if (embeddingDim <= 0)
        {
            return [];
        }

        var pooled = new float[embeddingDim];
        int validTokenCount = 0;

        for (int i = 0; i < tokenCount; i++)
        {
            if (attentionMask[i] == 1) // Sadece gerçek token'ları (padding olmayanları) hesaba kat
            {
                validTokenCount++;
                for (int j = 0; j < embeddingDim; j++)
                {
                    int index = i * embeddingDim + j;
                    if (index < tokenEmbeddings.Length)
                    {
                        pooled[j] += tokenEmbeddings.GetValue(index);
                    }
                }
            }
        }

        if (validTokenCount == 0)
        {
            return pooled;
        }

        for (int j = 0; j < embeddingDim; j++)
        {
            pooled[j] /= validTokenCount;
        }

        return pooled;
    }

    // İki vektör arasındaki anlamsal yakınlığı ölçen metot
    private static double CosineSimilarity(float[] vec1, float[] vec2)
    {
        ArgumentNullException.ThrowIfNull(vec1);
        ArgumentNullException.ThrowIfNull(vec2);

        if (vec1.Length != vec2.Length)
        {
            throw new ArgumentException("Vectors must have the same length");
        }

        if (vec1.Length == 0)
        {
            return 0.0;
        }

        double dotProduct = 0.0;
        double mag1 = 0.0;
        double mag2 = 0.0;

        for (int i = 0; i < vec1.Length; i++)
        {
            dotProduct += vec1[i] * vec2[i];
            mag1 += vec1[i] * vec1[i];
            mag2 += vec2[i] * vec2[i];
        }

        var magnitude = Math.Sqrt(mag1) * Math.Sqrt(mag2);
        return magnitude == 0 ? 0.0 : dotProduct / magnitude;
    }

    public void Dispose()
    {
        if (_disposed)
        {
            return;
        }

        _session?.Dispose();
        _disposed = true;
        
        GC.SuppressFinalize(this);
        _logger.LogInformation("OnnxTextAnalysisService disposed");
    }
}