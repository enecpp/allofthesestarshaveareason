using allofthesestarshaveareason.Services.Interfaces;
using allofthesestarshaveareason.Models;

namespace allofthesestarshaveareason.Services;

public class VideoAnalysisOrchestrator(
    ILogger<VideoAnalysisOrchestrator> logger,
    IJobRepository jobRepository,
    IFileStorageService fileStorage,
    IFFmpegService ffmpegService,
    ITranscriptService transcriptService,
    ISceneDetectionService sceneDetectionService) : IAnalysisService
{
    public async Task<string> StartAnalysisJobAsync(IFormFile file)
    {
        if (!ffmpegService.IsFFmpegAvailable())
        {
            throw new InvalidOperationException(
                "FFmpeg bulunamadı! Lütfen FFmpeg'i kurun ve sistem PATH'ine ekleyin.");
        }

        var jobId = await jobRepository.CreateJobAsync();
        logger.LogInformation("Starting analysis job: {JobId} for file: {FileName}", jobId, file.FileName);

        var videoPath = await fileStorage.SaveUploadedFileAsync(file, $"{jobId}_{file.FileName}");

        _ = Task.Run(async () => await ProcessVideoAsync(jobId, videoPath));

        return jobId;
    }

    public async Task<AnalysisStatus> GetAnalysisStatusAsync(string jobId)
    {
        var status = await jobRepository.GetJobStatusAsync(jobId);
        return status ?? new AnalysisStatus { Status = "Bulunamadı", Progress = 0 };
    }

    private async Task ProcessVideoAsync(string jobId, string videoPath)
    {
        string? audioPath = null;
        string? framesDirectory = null;

        try
        {
            await jobRepository.UpdateJobStatusAsync(jobId, "Ses ayıklanıyor...", 10);
            logger.LogInformation("Job {JobId}: Extracting audio", jobId);

            audioPath = Path.Combine("uploads", $"{jobId}.wav");
            await ffmpegService.ExtractAudioAsync(videoPath, audioPath);

            await jobRepository.UpdateJobStatusAsync(jobId, "Transkript oluşturuluyor...", 30);
            logger.LogInformation("Job {JobId}: Generating transcript", jobId);

            var transcriptProgress = new Progress<int>(count =>
            {
                logger.LogDebug("Job {JobId}: Processed {Count} transcript segments", jobId, count);
            });

            var transcript = await transcriptService.GenerateTranscriptAsync(
                audioPath,
                language: "auto",
                progress: transcriptProgress);

            logger.LogInformation("Job {JobId}: Transcript completed with {Count} segments",
                jobId, transcript.Count);

            await jobRepository.UpdateJobStatusAsync(jobId, "Sahneler tespit ediliyor...", 60);
            logger.LogInformation("Job {JobId}: Detecting scenes", jobId);

            framesDirectory = await fileStorage.CreateTemporaryDirectoryAsync(jobId);
            var frames = await ffmpegService.ExtractFramesAsync(videoPath, framesDirectory, framesPerSecond: 1);

            var sceneProgress = new Progress<int>(processed =>
            {
                var percentage = 60 + (processed * 20 / frames.Count);
                jobRepository.UpdateJobStatusAsync(jobId, "Sahneler tespit ediliyor...", percentage).Wait();
            });

            var scenes = await sceneDetectionService.DetectScenesAsync(
                frames,
                threshold: 0.7,
                progress: sceneProgress);

            logger.LogInformation("Job {JobId}: Scene detection completed with {Count} scenes",
                jobId, scenes.Count);

            await jobRepository.UpdateJobStatusAsync(jobId, "Sonuçlar kaydediliyor...", 90);
            logger.LogInformation("Job {JobId}: Saving results", jobId);

            await jobRepository.SaveJobResultsAsync(jobId, ([.. transcript], [.. scenes]));

            await jobRepository.CompleteJobAsync(jobId, resultId: 123);
            logger.LogInformation("Job {JobId}: Processing completed successfully", jobId);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Job {JobId}: Error during processing", jobId);
            await jobRepository.FailJobAsync(jobId, ex.Message);
        }
        finally
        {
            await CleanupResourcesAsync(jobId, audioPath, framesDirectory);
        }
    }

    private async Task CleanupResourcesAsync(string jobId, string? audioPath, string? framesDirectory)
    {
        if (!string.IsNullOrEmpty(audioPath))
        {
            try
            {
                await fileStorage.DeleteFileAsync(audioPath);
            }
            catch (Exception ex)
            {
                logger.LogWarning(ex, "Job {JobId}: Failed to delete audio file: {AudioPath}",
                    jobId, audioPath);
            }
        }

        if (!string.IsNullOrEmpty(framesDirectory))
        {
            try
            {
                await fileStorage.DeleteDirectoryAsync(framesDirectory);
            }
            catch (Exception ex)
            {
                logger.LogWarning(ex, "Job {JobId}: Failed to delete frames directory: {FramesDirectory}",
                    jobId, framesDirectory);
            }
        }
    }
}
